syntax = "proto3";

package yandex.cloud.priv.healthcheck.v1alpha;

import "google/protobuf/duration.proto";
import "google/protobuf/timestamp.proto";
import "yandex/cloud/priv/validation.proto";

option go_package = "a.yandex-team.ru/cloud/bitbucket/private-api/yandex/cloud/priv/healthcheck/v1alpha;healthcheck";
option java_outer_classname = "PHCG";

message HealthCheckGroup {
  enum Owner {
    OWNER_UNSPECIFIED = 0;
    LOAD_BALANCER = 1;
    INSTANCE_GROUP = 2;
  }

  message Target {
    string subnet_id = 1 [(length) = "<=50"];
    string address = 2;
  }

  string id = 1;

  repeated Target targets = 2;
  repeated HealthCheck health_checks = 3;

  google.protobuf.Timestamp created_at = 4;

  string folder_id = 5;

  Owner owner = 6;
}

message HealthCheck {
  message TcpOptions {
    int64 port = 1 [(value) = "1-65535"];
  }

  message HttpOptions {
    int64 port = 1 [(value) = "1-65535"];
    string path = 2;
    repeated int64 success_codes = 3 [(size) = "<=100"];
    map<string, string> headers = 4 [(size) = "<=100"];
  }

  message HttpsOptions {
    int64 port = 1 [(value) = "1-65535"];
    string host = 2;
    string path = 3;
    repeated int64 success_codes = 4 [(size) = "<=100"];
    map<string, string> headers = 5 [(size) = "<=100"];
    bool verify_hostname = 6;
    bool verify_cert_dates = 7;
  }

  message Http2Options {
    int64 port = 1 [(value) = "1-65535"];
    string host = 2;
    string path = 3;
    repeated int64 success_codes = 4 [(size) = "<=100"];
    map<string, string> headers = 5 [(size) = "<=100"];
    bool verify_hostname = 6;
    bool verify_cert_dates = 7;
  }

  message IcmpOptions {
  }

  // https://github.com/grpc/grpc/blob/master/doc/health-checking.md
  message GrpcOptions {
    int64 port = 1 [(value) = "1-65535"];
    string service_name = 2;
    string authority = 3;
  }

  string name = 1 [(required) = true, (pattern) = "|[a-z][-a-z0-9]{1,61}[a-z0-9]"];
  google.protobuf.Duration interval = 2 [(value) = "1s-300s"]; // default = 2s
  google.protobuf.Duration timeout = 3 [(value) = "1s-60s"]; // default = 1s
  int64 unhealthy_threshold = 4 [(value) = "2-10"]; // default = 2
  int64 healthy_threshold = 5 [(value) = "2-10"]; // default = 2

  oneof health_check_options {
    option (exactly_one) = true;

    TcpOptions tcp_options = 6;
    HttpOptions http_options = 7;
    HttpsOptions https_options = 9;
    Http2Options http2_options = 10;
    IcmpOptions icmp_options = 11;
    GrpcOptions grpc_options = 12;
  }

  enum AggregationAlgorithm {
    AGGREGATION_ALGORITHM_UNSPECIFIED = 0;
    ALL_OF = 1;
    AT_LEAST_ONE = 2;
    MAJORITY = 3;
  }

  AggregationAlgorithm aggregation_algorithm = 8 [(required) = false]; // default MAJORITY
}

message HealthCheckResult {
  enum Status {
    STATUS_UNSPECIFIED = 0;
    INITIAL = 1;
    HEALTHY = 2;
    UNHEALTHY = 3;
    DRAINING = 4;
    INACTIVE = 5;
  }

  string health_check_group_id = 1;
  string name = 2;
  string subnet_id = 3;
  string address = 4;
  Status status = 5;
  google.protobuf.Timestamp status_changed_at = 6;
}
