syntax = "proto3";

package yandex.cloud.priv.mdb.mysql.v1;

import "google/protobuf/timestamp.proto";
import "yandex/cloud/priv/validation.proto";
import "yandex/cloud/priv/mdb/mysql/v1/perf_diag.proto";

option go_package = "a.yandex-team.ru/cloud/bitbucket/private-api/yandex/cloud/priv/mdb/mysql/v1;mysql";
option java_outer_classname = "PMDIAGS";

// A set of methods for getting MySQL performance diagnostics.
service PerformanceDiagnosticsService {

  rpc GetSessionsStats (GetSessionsStatsRequest) returns (GetSessionsStatsResponse);
  rpc GetSessionsAtTime (GetSessionsAtTimeRequest) returns (GetSessionsAtTimeResponse);

  rpc GetStatementsDiff (GetStatementsDiffRequest) returns (GetStatementsDiffResponse);
  rpc GetStatementsAtTime (GetStatementsAtTimeRequest) returns (GetStatementsAtTimeResponse);
  rpc GetStatementsInterval (GetStatementsIntervalRequest) returns (GetStatementsIntervalResponse);
  rpc GetStatementsStats (GetStatementsStatsRequest) returns (GetStatementsStatsResponse);
  rpc GetStatementStats (GetStatementStatsRequest) returns (GetStatementStatsResponse);
}

message GetSessionsStatsRequest {
  enum GroupBy {
    GROUP_BY_UNSPECIFIED = 0;
    TIME = 1;
    HOST = 2;
    DATABASE = 3;
    USER = 4;
    STAGE = 5;
    CURRENT_WAIT = 6;
    WAIT_OBJECT = 7;
    CLIENT_HOSTNAME = 8;
    DIGEST = 9;
  }

  enum SortOrder {
    SORT_ORDER_UNSPECIFIED = 0;
    ASC = 1;
    DESC = 2;
  }

  message OrderBy {
    GroupBy field = 1;
    SortOrder order = 2;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 2 [(length) = "<=1000"];

  // Start timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp from_time = 3;

  // End timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp to_time = 4;

  repeated GroupBy group_by = 5 [(size) = ">0"];

  // It is used only if grouping by time is enabled.
  // In seconds. Valid values are 1, 15, 60, 300, 600, 1800, 3600, 21600, 86400.
  int64 rollup_period = 6 [(value) = "<=86400"];

  repeated OrderBy order_by = 7;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetSessionsStatsResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 8 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsStatsResponse.next_page_token] returned by a previous list request.
  string page_token = 9 [(length) = "<=100"];
}

message GetSessionsStatsResponse {
  message Stats {
    google.protobuf.Timestamp time = 1;
    map<string, string> dimensions = 2;
    int64 sessions_count = 3;
  }

  repeated Stats stats = 1;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetSessionsStatsRequest.page_size], use the [next_page_token] as the value
  // for the [GetSessionsStatsRequest.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 2;
}

message GetSessionsAtTimeRequest {
  enum Field {
    FIELD_UNSPECIFIED = 0;
    TIME = 1;
    HOST = 2;
    DATABASE = 3;
    USER = 4;
    CONN_ID = 5;
    COMMAND = 6;
    QUERY = 7;
    DIGEST = 8;
    QUERY_LATENCY = 9;
    LOCK_LATENCY = 10;
    STAGE = 11;
    STAGE_LATENCY = 12;
    CURRENT_WAIT = 13;
    WAIT_OBJECT = 14;
    WAIT_LATENCY = 15;
    TRX_LATENCY = 16;
    CURRENT_MEMORY = 17;
    CLIENT_ADDR = 18;
    CLIENT_HOSTNAME = 19;
  }

  enum SortOrder {
    SORT_ORDER_UNSPECIFIED = 0;
    ASC = 1;
    DESC = 2;
  }

  message OrderBy {
    Field field = 1;
    SortOrder order = 2;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // Columns from sessions view to request.
  // If no columns are specified, entire records are returned.
  repeated Field column_filter = 2;

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 3 [(length) = "<=1000"];

  // Timestamp at which to show sessions state, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp time = 4;

  repeated OrderBy order_by = 5;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetSessionsAtTimeResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 6 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsAtTimeResponse.next_page_token] returned by a previous list request.
  string page_token = 7 [(length) = "<=100"];
}

message GetSessionsAtTimeResponse {
  repeated SessionState sessions = 1;

  // Timestamp when previous sessions state was collected, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp previous_collect_time = 2;

  // Timestamp when next sessions state was collected, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp next_collect_time = 3;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetSessionsAtTimeRequest.page_size], use the [next_page_token] as the value
  // for the [GetSessionsAtTimeRequest.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 4;
}


message GetStatementsDiffRequest {
  enum Field {
    FIELD_UNSPECIFIED = 0;
    TIME = 1;
    HOST = 2;
    DATABASE = 3;
    DIGEST = 4;
    QUERY = 5;
    TOTAL_QUERY_LATENCY = 6;
    TOTAL_LOCK_LATENCY = 7;
    AVG_QUERY_LATENCY = 8;
    AVG_LOCK_LATENCY = 9;
    CALLS = 10;
    ERRORS = 11;
    WARNINGS = 12;
    ROWS_EXAMINED = 13;
    ROWS_SENT = 14;
    ROWS_AFFECTED = 15;
    TMP_TABLES = 16;
    TMP_DISK_TABLES = 17;
    SELECT_FULL_JOIN = 18;
    SELECT_FULL_RANGE_JOIN = 19;
    SELECT_RANGE = 20;
    SELECT_RANGE_CHECK = 21;
    SELECT_SCAN = 22;
    SORT_MERGE_PASSES = 23;
    SORT_RANGE = 24;
    SORT_ROWS = 25;
    SORT_SCAN = 26;
    NO_INDEX_USED = 27;
    NO_GOOD_INDEX_USED = 28;
  }

  enum SortOrder {
    SORT_ORDER_UNSPECIFIED = 0;
    ASC = 1;
    DESC = 2;
  }

  message OrderBy {
    Field field = 1;
    SortOrder order = 2;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // Columns from events_statements_summary_by_digest to request.
  // If no columns are specified, entire records are returned.
  repeated Field column_filter = 2;

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 3 [(length) = "<=1000"];

  // Start timestamp of the first interval for diff, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp first_interval_start = 4;

  // Start timestamp of the second interval for diff, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp second_interval_start = 5;

  // In seconds. Valid values are 0, 60, 300, 600, 1800, 3600, 21600, 86400.
  // 0 means that we want to get diff between two points in time, not two time intervals.
  int64 intervals_duration = 6 [(value) = "<=86400"];

  repeated OrderBy order_by = 7;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetSessionsAtTimeResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 8 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsAtTimeResponse.next_page_token] returned by a previous list request.
  string page_token = 9 [(length) = "<=100"];
}

message GetStatementsDiffResponse {
  repeated DiffStatement diff_statements = 1;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetStatementsDiffRequest.page_size], use the [next_page_token] as the value
  // for the [GetStatementsDiffRequest.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 2;
}

message GetStatementsAtTimeRequest {
  enum Field {
    FIELD_UNSPECIFIED = 0;
    TIME = 1;
    HOST = 2;
    DATABASE = 3;
    DIGEST = 4;
    QUERY = 5;
    TOTAL_QUERY_LATENCY = 6;
    TOTAL_LOCK_LATENCY = 7;
    AVG_QUERY_LATENCY = 8;
    AVG_LOCK_LATENCY = 9;
    CALLS = 10;
    ERRORS = 11;
    WARNINGS = 12;
    ROWS_EXAMINED = 13;
    ROWS_SENT = 14;
    ROWS_AFFECTED = 15;
    TMP_TABLES = 16;
    TMP_DISK_TABLES = 17;
    SELECT_FULL_JOIN = 18;
    SELECT_FULL_RANGE_JOIN = 19;
    SELECT_RANGE = 20;
    SELECT_RANGE_CHECK = 21;
    SELECT_SCAN = 22;
    SORT_MERGE_PASSES = 23;
    SORT_RANGE = 24;
    SORT_ROWS = 25;
    SORT_SCAN = 26;
    NO_INDEX_USED = 27;
    NO_GOOD_INDEX_USED = 28;
  }

  enum SortOrder {
    SORT_ORDER_UNSPECIFIED = 0;
    ASC = 1;
    DESC = 2;
  }

  message OrderBy {
    Field field = 1;
    SortOrder order = 2;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // Columns from events_statements_summary_by_digest to request.
  // If no columns are specified, entire records are returned.
  repeated Field column_filter = 2;

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 3 [(length) = "<=1000"];

  // Timestamp at which to show sessions state, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp time = 4;

  repeated OrderBy order_by = 5;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetSessionsAtTimeResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 6 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsAtTimeResponse.next_page_token] returned by a previous list request.
  string page_token = 7 [(length) = "<=100"];
}

message GetStatementsAtTimeResponse {
  repeated Statement statements = 1;

  // Timestamp when previous statements stats was collected, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp previous_collect_time = 2;

  // Timestamp when next statements stats was collected, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp next_collect_time = 3;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetStatementsAtTimeRequest.page_size], use the [next_page_token] as the value
  // for the [GetStatementsAtTimeRequest.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 4;
}

message GetStatementsIntervalRequest {
  enum Field {
    FIELD_UNSPECIFIED = 0;
    TIME = 1;
    HOST = 2;
    DATABASE = 3;
    DIGEST = 4;
    QUERY = 5;
    TOTAL_QUERY_LATENCY = 6;
    TOTAL_LOCK_LATENCY = 7;
    AVG_QUERY_LATENCY = 8;
    AVG_LOCK_LATENCY = 9;
    CALLS = 10;
    ERRORS = 11;
    WARNINGS = 12;
    ROWS_EXAMINED = 13;
    ROWS_SENT = 14;
    ROWS_AFFECTED = 15;
    TMP_TABLES = 16;
    TMP_DISK_TABLES = 17;
    SELECT_FULL_JOIN = 18;
    SELECT_FULL_RANGE_JOIN = 19;
    SELECT_RANGE = 20;
    SELECT_RANGE_CHECK = 21;
    SELECT_SCAN = 22;
    SORT_MERGE_PASSES = 23;
    SORT_RANGE = 24;
    SORT_ROWS = 25;
    SORT_SCAN = 26;
    NO_INDEX_USED = 27;
    NO_GOOD_INDEX_USED = 28;
  }

  enum SortOrder {
    SORT_ORDER_UNSPECIFIED = 0;
    ASC = 1;
    DESC = 2;
  }

  message OrderBy {
    Field field = 1;
    SortOrder order = 2;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // Columns from events_statements_summary_by_digest to request.
  // If no columns are specified, entire records are returned.
  repeated Field column_filter = 2;

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 3 [(length) = "<=1000"];

  // Start timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp from_time = 4;

  // End timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp to_time = 5;

  repeated OrderBy order_by = 6;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetSessionsAtTimeResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 7 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsAtTimeResponse.next_page_token] returned by a previous list request.
  string page_token = 8 [(length) = "<=100"];
}

message GetStatementsIntervalResponse {
  repeated Statement statements = 1;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetStatementsAtTimeRequest.page_size], use the [next_page_token] as the value
  // for the [GetStatementsAtTimeRequest.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 2;
}

message GetStatementsStatsRequest {

  enum GroupBy {
    GROUP_BY_UNSPECIFIED = 0;
    HOST = 1;
    DATABASE = 2;
  }

  enum Field {
    FIELD_UNSPECIFIED = 0;
    DIGEST = 1;
    QUERY = 2;
    TOTAL_QUERY_LATENCY = 3;
    TOTAL_LOCK_LATENCY = 4;
    AVG_QUERY_LATENCY = 5;
    AVG_LOCK_LATENCY = 6;
    CALLS = 7;
    ERRORS = 8;
    WARNINGS = 9;
    ROWS_EXAMINED = 10;
    ROWS_SENT = 11;
    ROWS_AFFECTED = 12;
    TMP_TABLES = 13;
    TMP_DISK_TABLES = 14;
    SELECT_FULL_JOIN = 15;
    SELECT_FULL_RANGE_JOIN = 16;
    SELECT_RANGE = 17;
    SELECT_RANGE_CHECK = 18;
    SELECT_SCAN = 19;
    SORT_MERGE_PASSES = 20;
    SORT_RANGE = 21;
    SORT_ROWS = 22;
    SORT_SCAN = 23;
    NO_INDEX_USED = 24;
    NO_GOOD_INDEX_USED = 25;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // Columns from events_statements_summary_by_digest to request.
  // If no columns are specified, entire records are returned.
  repeated Field column_filter = 2;

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 3 [(length) = "<=1000"];

  // Start timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp from_time = 4;

  // End timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp to_time = 5;

  repeated GroupBy group_by = 6;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetStatementsStatsResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 7 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsStatsResponse.next_page_token] returned by a previous list request.
  string page_token = 8 [(length) = "<=100"];
}

message GetStatementsStatsResponse {
  repeated Statement statements = 1;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetStatementStats.page_size], use the [next_page_token] as the value
  // for the [GetStatementStats.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 3;
}

message GetStatementStatsRequest {

  enum GroupBy {
    GROUP_BY_UNSPECIFIED = 0;
    HOST = 1;
    DATABASE = 2;
  }

  enum Field {
    FIELD_UNSPECIFIED = 0;
    DIGEST = 1;
    QUERY = 2;
    TOTAL_QUERY_LATENCY = 3;
    TOTAL_LOCK_LATENCY = 4;
    AVG_QUERY_LATENCY = 5;
    AVG_LOCK_LATENCY = 6;
    CALLS = 7;
    ERRORS = 8;
    WARNINGS = 9;
    ROWS_EXAMINED = 10;
    ROWS_SENT = 11;
    ROWS_AFFECTED = 12;
    TMP_TABLES = 13;
    TMP_DISK_TABLES = 14;
    SELECT_FULL_JOIN = 15;
    SELECT_FULL_RANGE_JOIN = 16;
    SELECT_RANGE = 17;
    SELECT_RANGE_CHECK = 18;
    SELECT_SCAN = 19;
    SORT_MERGE_PASSES = 20;
    SORT_RANGE = 21;
    SORT_ROWS = 22;
    SORT_SCAN = 23;
    NO_INDEX_USED = 24;
    NO_GOOD_INDEX_USED = 25;
  }

  // ID of the MySQL cluster to request sessions history for.
  // To get the MySQL cluster ID use a [ClusterService.List] request.
  string cluster_id = 1 [(required) = true, (length) = "<=50"];

  // Digest of mysql query to get statistics for
  string digest = 2 [(required) = true, (length) = "<=50"];

  // Columns from events_statements_summary_by_digest to request.
  // If no columns are specified, entire records are returned.
  repeated Field column_filter = 3;

  // A filter expression that filters rows listed in the response.
  // The expression must specify:
  // 1. The column name.
  // 2. An operator. Can be either `=` or `!=` for single values, `IN` or `NOT IN` for lists of values.
  // 3. The value. Must be 1-63 characters long and match the regular expression `^[a-zA-Z0-9_-]+$`.
  string filter = 4 [(length) = "<=1000"];

  // Start timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp from_time = 5;

  // End timestamp for the request, in [RFC3339](https://www.ietf.org/rfc/rfc3339.txt) text format.
  google.protobuf.Timestamp to_time = 6;

  repeated GroupBy group_by = 7;

  // The maximum number of results per page to return. If the number of available
  // results is larger than [page_size], the service returns a [GetStatementStatsResponse.next_page_token]
  // that can be used to get the next page of results in subsequent list requests.
  int64 page_size = 8 [(value) = "<=10000"];

  // Page token. To get the next page of results, set [page_token] to the
  // [GetSessionsStatsResponse.next_page_token] returned by a previous list request.
  string page_token = 9 [(length) = "<=100"];
}

message GetStatementStatsResponse {
  repeated Statement statements = 1;

  // Digest query string
  string query = 2;

  // This token allows you to get the next page of results for list requests. If the number of results
  // is larger than [GetStatementStats.page_size], use the [next_page_token] as the value
  // for the [GetStatementStats.page_token] parameter in the next list request. Each subsequent
  // list request will have its own [next_page_token] to continue paging through the results.
  string next_page_token = 3;
}
